<template>
  <div class="cloudcontent">
    <div class="main">
      <div class="basic-info-title">档案基本信息</div>
      <el-form :model="form">
        <el-row>
          <el-col :span="12">
            <el-form-item label="档案名称：">
              <span>{{form.name}}</span>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="档案编码：">
              <span>{{form.archivesCode}}</span>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="12">
            <el-form-item label="移交人：">
              <span>{{form.lastTransferName}}</span>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="档案管理员：">
              <span>{{form.adminName}}</span>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="12">
            <el-form-item label="归档时间：">
              <span>{{form.filingTime}}</span>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="档案状态：">
              <span>正常</span>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
      <div class="basic-info-title">实物档案位置</div>
      <el-form :model="positionForm" :rules="rules" ref="positionForm" :validate-on-rule-change="true">
        <el-form-item class="bitianicon" label="实物位置：">
          <el-select class="position-select" v-model="positionForm.room" placeholder="请选择" @change="getArchivesCabinet">
            <el-option
              v-for="item in roomOptions"
              :key="item.objectId"
              :label="item.name"
              :value="item.objectId">
            </el-option>
          </el-select>
          <el-select class="position-select" v-model="positionForm.cabinet" placeholder="请选择" @change="getLayerNumber">
            <el-option
              v-for="item in cabinetList"
              :key="item.objectId"
              :label="item.name"
              :value="item.objectId">
            </el-option>
          </el-select>
          <el-select class="position-select" v-model="positionForm.layerNumber" placeholder="请选择">
            <el-option
              v-for="item in layerNumberList"
              :key="item.layerNumber"
              :label="item.layerNumber"
              :value="item.layerNumber">
            </el-option>
          </el-select>
          <el-input class="position-input" v-model="positionForm.locationDescription"></el-input>
        </el-form-item>
        <el-form-item label="实物档案编号：">
          <el-input class="position-input" v-model="positionForm.physicalNumber"></el-input>
        </el-form-item>
        <el-table
          :data="tableData.filter(item => Number(item.status) === 1)"
          border
          style="width: 60%" header-cell-class-name="tableheader">
          <el-table-column
            width="50"
            type="index"
            align="center"
            label="序号">
          </el-table-column>
          <el-table-column
            prop="name"
            label="档案目录"
            align="center"
            width="200"
            show-overflow-tooltip>
          </el-table-column>
          <el-table-column
            label="详细位置描述"
            align="center"
            show-overflow-tooltip>
            <template slot-scope="scope" v-if="scope.row.name !== '电子档案'">
              <el-input v-model="scope.row.locationDescription"></el-input>
            </template>
            <template v-else>
              <span>---</span>
            </template>
          </el-table-column>
        </el-table>
      </el-form>
    </div>
  </div>
</template>
<script>
import {archivesInfo, archivesRoom} from '@/api/archives'
export default {
  components: {
  },
  data () {
    return {
      form: {
      },
      objectId: '',
      positionForm: {
        room: '',
        layerNumber: '',
        cabinet: ''
      },
      tableData: [],
      rules: {
        room: [
          { required: true, message: '请选择档案室', trigger: ['blur', 'change'] }
        ]
      },
      roomOptions: [],
      cabinetList: [],
      layerNumberList: []
    }
  },
  methods: {
    getInfo () {
      let isSetRecord = 0 // 不设置查询记录
      archivesInfo.detailArchivesInfo(this.objectId, isSetRecord).then((res) => {
        if (res.data.resCode === '0000') {
          this.form = res.data.archivesInfo
          this.tableData = res.data.archivesInfo.archivesClassifyList
        }
      })
      // 获取档案室
      archivesRoom.getArchivesRoomList({
        enterpriseId: this.$store.getters.authUser.enterpriseId
      }).then((res) => {
        if (res.data.resCode === '0000') {
          this.roomOptions = res.data.archivesRoomList.list
        }
      })
    },
    getArchivesCabinet (id) {
      this.cabinetList = []
      this.roomOptions.forEach(room => {
        if (room.objectId === id) {
          this.cabinetList = room.archivesCabinetList
        }
      })
    },
    getLayerNumber (id) {
      this.layerNumberList = []
      this.cabinetList.forEach(cabinet => {
        if (cabinet.objectId === id) {
          for (let i = 1; i < Number(cabinet.layerNumber) + 1; i++) {
            this.layerNumberList.push({layerNumber: i + '层'})
          }
        }
      })
    },
    save () {
      if (!this.positionForm.room) {
        this.$message({
          message: '请选择实物位置',
          type: 'warning'
        })
        return false
      }
      this.form.archivesRoomId = this.positionForm.room
      this.form.archivesCabinetId = this.positionForm.cabinet
      this.form.archivesCabinetLayerNumber = this.positionForm.layerNumber
      this.form.locationDescription = this.positionForm.locationDescription
      this.form.physicalNumber = this.positionForm.physicalNumber
      this.form.archivesClassifyList = this.tableData.filter(item => Number(item.status) === 1)
      archivesInfo.updateArchivesInfo(this.form).then((res) => {
        if (res.data.resCode === '0000') {
          this.$store.commit('delete_tabs', this.$route.fullPath)
          this.$router.push({path: '/archives/management'})
        }
      })
    }
  },
  mounted () {
    this.objectId = this.$route.params.objectId
    this.getInfo()
  }
}
</script>
<style lang="less">
  .position-select {
    width: 200px;
  }
  .position-input {
    width: 30%;
  }
</style>
